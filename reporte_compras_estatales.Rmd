---
title: "Compras Estatales"
author: 
- "Daniel Czarnievicz" 
- "Damian Dapueto"
- "Emanuelle"
date: "Última actualización: `r format(Sys.time(), '%A %d %B, %Y, %I:%M %p')`"
output: 
  html_document:
    toc: true
    toc_depth: 2
    number_sections: true
    toc_float: 
      smooth_scroll: true
    theme: united
    highlight: tango
    fig_caption: yes
    code_folding: hide
    includes:
      in_header: header.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
knitr::knit_hooks$set(inline = function(x) {prettyNum(x, big.mark = ".")})
library(knitr)
library(tidyverse)
library(lubridate)
library(formattable)
library(kableExtra)
library(magrittr)
library(dplyr)
library(plotly)
```

```{r}
#Datasets
compras <- readr::read_rds("Data/rds/compras.rds")
adjudicaciones <- readr::read_rds("Data/rds/adjudicaciones.rds")
oferentes <- readr::read_rds("Data/rds/oferentes.rds")

#funciones o variables comunes en estudio
# datasets agrupado en week con variables comunes
compras_week <- compras %>% 
  filter("2018-01-01" < fecha_compra, fecha_compra < "2019-04-30", monto_adj > 0) %>%
  group_by(floor_date(fecha_compra, "week")) %>% 
  summarise(total_comprado = sum(monto_adj_pesos, na.rm = TRUE) ,
            cantidad_comprado = n(),
            monto_promedio_por_semana = total_comprado/cantidad_comprado) %>% 
  mutate(is_low_monto = ifelse(total_comprado <= quantile(total_comprado,probs=0.05), 1, NA), 
         is_high_monto = ifelse(total_comprado >= quantile(total_comprado,probs=0.95), 1, NA), 
         is_outlier_monto = case_when(
                total_comprado < quantile(total_comprado,probs = 0.25) - 1.5 * IQR(total_comprado) | total_comprado > quantile(total_comprado, probs = 0.75) + 1.5 * IQR(total_comprado) ~ TRUE,
                TRUE ~ FALSE) 
           ) %>%
  mutate(is_low_cto = ifelse(cantidad_comprado <= quantile(cantidad_comprado,probs=0.05), 1, NA), 
         is_high_cto = ifelse(cantidad_comprado >= quantile(cantidad_comprado,probs=0.95), 1, NA), 
         is_outlier_cto = case_when(
                cantidad_comprado < quantile(cantidad_comprado,probs = 0.25) - 1.5 * IQR(cantidad_comprado) | cantidad_comprado > quantile(cantidad_comprado, probs = 0.75) + 1.5 * IQR(cantidad_comprado) ~ TRUE,
                TRUE ~ FALSE) 
           ) %>%
  mutate(is_low_mean = ifelse(monto_promedio_por_semana <= quantile(monto_promedio_por_semana,probs=0.05), 1, NA), 
         is_high_monto = ifelse(monto_promedio_por_semana >= quantile(monto_promedio_por_semana,probs=0.95), 1, NA), 
         is_outlier_monto = case_when(
                monto_promedio_por_semana < quantile(monto_promedio_por_semana,probs = 0.25) - 1.5 * IQR(monto_promedio_por_semana) | monto_promedio_por_semana > quantile(monto_promedio_por_semana, probs = 0.75) + 1.5 * IQR(monto_promedio_por_semana) ~ TRUE,
                TRUE ~ FALSE) 
           ) %>%
  
  rename(week_date = `floor_date(fecha_compra, "week")`)


#total compras
cto_compras <- compras %>% 
                  count(id_compra) %>% 
                  dim() %>% 
                  .[1]
#total gastado en pesos uruguayos
monto_total <- sum(compras$monto_adj_pesos)





```

# Introduccion {.tabset .tabset-fade .tabset-pills}


 Se realiza un investigacion sobre las adjudicaciones realizadas por el Estado y todos sus entes vinculados. Pudiendo observar todos los tipos de compras como tambien que productos son los que se compraron y quienes son los principales vendedores.  
 
 
 
 Esta investigacion se origina realizando una [web-scrapping][1][^1] donde se extrajo los datos y luego se realiza una limpieza de todo lo extraible [script][2], teniendo 3 base de datos ( compras,  adjudicaciones y oferentes)  
 
 



# Analisis Exploratorio

## Compras

Como datos generales podemos observar que hubo dentro del periodo de investigacion unas `r cto_compras` compras adjudicadas que alcancaza `r monto_total / 1000000` millones de pesos uruguayos . Hay que tener en cuenta como se dijo antes , que estosson datos aproximados dado que no todos los entes publicos han ingresado su gastos com por ejemplo la intendencia de Rocha donde no encontramos ninguna adjudicacion.  


Esta claro que el proceso que se esta transitando con respecto al [decreto][3] es costoso dado los cambios de metodologia de trabajo de los entes publicos y por lo tanto no se esta obteniendo toda la informacion adecuada.  


Uno de los primero graaficos que crremos es muy importante de visualizar es un grafico lineal que nos brainda una serie de tiempo en base al monto gastado en pesos uruguayos.  





```{r,fig.align='center', fig.cap="Evolución del monto total adjudicado por mes\n(en millones de pesos corrientes)"}
ggplotly(ggplot(compras_week) +
  geom_line(aes(week_date, total_comprado), color = "purple") +
  labs(x = NULL, y = "Monto total adjudicado por semana\n(equivalente en millones de pesos corrientes)\n") +
  scale_y_continuous(labels = scales::dollar_format(prefix = "$U", big.mark = ".", decimal.mark = ",", scale = 1/1e6)) +
  ggthemes::theme_economist() +
  theme(axis.title = element_text(face = "bold")) +
  geom_point(data = compras_week %>% dplyr::filter(is_outlier_monto == TRUE), aes(week_date, total_comprado), color = 'red', size = 5, alpha = 0.5)+
  geom_point(data = compras_week %>% dplyr::filter(is_low_monto == 1), aes(week_date, total_comprado), color = 'blue', size = 2) +
  geom_point(data = compras_week %>% dplyr::filter(is_high_monto == 1), aes(week_date, total_comprado), color = 'darkred', size = 2)) %>%
  layout(width=850)
```

Como se puede ver vemos algunos picos u anomalias (marcados con puntos rojos grandes) que nos denotan que en ese periodo fue el mayor gasto del pais en compras.  
Muy importante avisar que se evalua en un periodo de tiempo semanal desde Enero 2018 hasta Abril 2019.  
La semana donde hay mas gasto adjudicado es en `r compras_week %>% arrange(desc(total_comprado)) %>% head(1) %>% select(week_date)`.  




```{r, fig.align='left', fig.cap="Evolución de la cantidad de adjudicaciones mensuales"}
ggplotly(ggplot(compras_week) +
  geom_line(aes(week_date, cantidad_comprado), color = "orange") +
  labs(x = NULL, y = "Cantidad de adjudicaciones mensuales\n") +
  #scale_y_continuous(labels = scales::number_format(big.mark = ".", decimal.mark = ",")) +
  ggthemes::theme_economist() +
  theme(axis.title = element_text(face = "bold")) +
  geom_point(data = compras_week %>% dplyr::filter(is_outlier_cto == TRUE), aes(week_date, cantidad_comprado), color = 'red', size = 5, alpha = 0.5)+
  geom_point(data = compras_week %>% dplyr::filter(is_low_cto == 1), aes(week_date, cantidad_comprado), color = 'blue', size = 2) +
  geom_point(data = compras_week %>% dplyr::filter(is_high_cto == 1), aes(week_date, cantidad_comprado), color = 'darkred', size = 2)) %>%
  layout(width=850)
```

```{r, fig.align='center', fig.cap="Monto total adjudicado por semana en función de la cantidad de adjudicaciones realizadas."}
#Hice esta visualización porque me llama la atención que en las dos gráficas anteriores, antes de abril de 2018 se da el maximo del monto adjudicado pero el minimo de cantidad de adjudicaciones. Para poder analizar eso bien hacen falta las tasas de cambio (sino de la grafica de mondo adjudicado por semana no se puede sacar ninguna información. También habría que ver si vamos a sacar las compras que no se realizaron de la base.
compras %>% 
  filter("2018-01-01" < fecha_compra, fecha_compra < "2018-12-31", monto_adj > 0) %>%
  group_by(floor_date(fecha_compra, "week"), monto_adj_pesos) %>% 
  tally() %>% 
  summarise(cant_adjs = sum(n), 
            total_comprado = sum(monto_adj_pesos, na.rm = TRUE)) %>% 
  filter(cant_adjs >= quantile(cant_adjs)[2] / 1.5) %>%
  ggplot() + 
  geom_line(aes(x = cant_adjs, y = total_comprado)) +
  labs(x = "Cantidad de adjudicaciones mensuales\n", 
       y = "Monto total adjudicado por semana\n(equivalente en millones de pesos corrientes)\n") +
  scale_y_continuous(labels = scales::dollar_format(prefix = "$U", big.mark = ".", decimal.mark = ",", scale = 1/1e6)) +
  ggthemes::theme_economist() +
  theme(axis.title = element_text(face = "bold"))
```

```{r fig.align='center', fig.cap="Asociación entre el tiempo que requiró concluir la compra (span) y el monto involucrado en la compra según moneda de la compra. No parecería existir una relación entre las mismas."}
compras %>% 
  mutate(span = (fecha_compra %--% fecha_pub_adj) %/% hours(1),
         pesos = if_else(id_moneda == 0, "Compra en pesos", "Compra en otra moneda")) %>% 
  ggplot() +
  geom_point(aes(log(span), log(monto_adj_pesos), color = pesos), alpha = 1/5) +
  facet_wrap(~pesos) +
  labs(x = "\nSpan de la compra (en logs - en días)", 
       y = "Monto de la compra\n(en logs - en pesos corrientes)\n", 
       color = NULL) +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  ggthemes::theme_economist() +
  theme(axis.title = element_text(face = "bold"),
        legend.position = "bottom")
```

```{r fig.align='center', fig.cap="Distribución del logaritmo del tiempo que requiró concluir la compra (span) según si la misma tuvo o no apertura electrónica."}
compras %>% 
  filter(!is.na(apel)) %>% 
  mutate(span = (fecha_compra %--% fecha_pub_adj) %/% hours(1),
         pesos = if_else(id_moneda == 0, "Compra en pesos", "Compra en otra moneda"),
         apel = if_else(apel == "Yes", "Sí", "No")) %>% 
  ggplot() +
  geom_histogram(aes(x = log(span), y = ..density.., fill = apel)) +
  facet_wrap(~apel) +
  labs(x = "Span de la compra (en logs - en días)", y = "Proporción\n", fill = "Apertura\nElectrónica") +
  ggthemes::theme_economist() +
  theme(axis.title = element_text(face = "bold"),
        legend.position = "bottom",
        strip.text = element_blank())
```


```{r, fig.align='center', fig.cap="Evolución del monto total adjudicado por mes por la intendencia de Montevideo\n(en millones de pesos corrientes)"}
compras %>%
  filter (id_inciso==98) %>%
  filter("2018-01-01" < fecha_compra, fecha_compra < "2018-12-31", monto_adj > 0) %>%
  group_by(floor_date(fecha_compra, "week")) %>% 
  summarise(total_comprado = sum(monto_adj_pesos, na.rm = TRUE)) %>% 
  ggplot() +
  geom_line(aes(`floor_date(fecha_compra, "week")`, total_comprado), color = "purple") +
  labs(x = NULL, y = "Monto total adjudicado por semana\n(equivalente en millones de pesos corrientes)\n") +
  scale_y_continuous(labels = scales::dollar_format(prefix = "$U", big.mark = ".", decimal.mark = ",", scale = 1/1e6)) +
  ggthemes::theme_economist() +
  theme(axis.title = element_text(face = "bold"))
```
Se puede observar que el monto total adjudicado semanalmente por la Intendencia de Montevideo se mantiene generalmente en una franja de entre 0 y 300 millones de pesos uruguayos.

Existe únicamente un pico, sobre el final del año 2018, cuando se adjudicaron unos 500 millones de pesos.


```{r, fig.align='center', fig.cap="Evolución del monto total adjudicado por mes por la intendencia de Montevideo\n(en millones de pesos corrientes)"}
# Falta tasas de cambio
#a<-compras %>%
#  mutate(id_inciso=as.numeric(id_inciso)) 
#  filter (id_inciso>=80) %>% head()
#  filter("2018-01-01" < fecha_compra, fecha_compra < "2018-12-31", monto_adj > 0) %>%
#  group_by(floor_date(fecha_compra, "week")) %>% 
#  summarise(total_comprado = sum(monto_adj_pesos, na.rm = TRUE)) %>% 
#  ggplot() +
#  geom_line(aes(`floor_date(fecha_compra, "week")`, total_comprado), color = "purple") +
#  labs(x = NULL, y = "Monto total adjudicado por semana\n(equivalente en millones de pesos corrientes)\n") +
#  scale_y_continuous(labels = scales::dollar_format(prefix = "$U", big.mark = ".", decimal.mark = ",", scale = 1/1e6)) +
#  ggthemes::theme_economist() +
#  theme(axis.title = element_text(face = "bold"))
```

```{r, fig.align='center', fig.cap="Evolución del monto total adjudicado por mes por la Udelar\n(en millones de pesos corrientes)"}
# Falta tasas de cambio
compras %>%
  filter (id_inciso==26) %>%
  filter("2018-01-01" < fecha_compra, fecha_compra < "2018-12-31", monto_adj > 0) %>%
  group_by(floor_date(fecha_compra, "week")) %>% 
  summarise(total_comprado = sum(monto_adj_pesos, na.rm = TRUE)) %>% 
  ggplot() +
  geom_line(aes(`floor_date(fecha_compra, "week")`, total_comprado), color = "purple") +
  labs(x = NULL, y = "Monto total adjudicado por semana\n(equivalente en millones de pesos corrientes)\n") +
  scale_y_continuous(labels = scales::dollar_format(prefix = "$U", big.mark = ".", decimal.mark = ",", scale = 1/1e6)) +
  ggthemes::theme_economist() +
  theme(axis.title = element_text(face = "bold"))
```


## oferentes 

```{r}
# Cantidad de oferentes
cant_provs_oferentes <- oferentes %>% 
  count(nro_doc_prov) %>% 
  dim() %>% 
  .[1]
# Cantidad de compras
cant_compras <- compras %>% 
  count(id_compra) %>% 
  dim() %>% 
  .[1]
```

La base cuenta con información sobre `r cant_provs_oferentes` proveedores, los cuales han partidicado de un total de `r cant_compras` compras. El proveedor más frecuente durante 2018 fue Nalfer SA, quien participó en el 4,10% de las compras.

```{r}
# Principales oferentes del estado
oferentes %>% 
  group_by(nro_doc_prov, nombre_comercial) %>% 
  summarise(n_compras = n_distinct(id_compra)) %>% 
  ungroup() %>%
  mutate(prop = percent(n_compras / sum(n_compras), digits = 2)) %>%
  arrange(desc(n_compras, nombre_comercial)) %>%
  select(nombre_comercial, nro_doc_prov, n_compras, prop) %>% 
  head(10) %>%
  kable(format = "html", format.args = list(big.mark = ".", decimal.mark = ","), escape = FALSE,
        caption = "Principales oferentes del Estado en 2018 y 2019",
        col.names = c("Proveedor", "ID", "Cantidad", "Proporción")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```
```{r, fig.align='center', fig.cap="Evolución del monto total adjudicado por mes por las intendencias del país\n(en millones de pesos corrientes)"}
compras %>%
  filter(grepl("Intendencia", inciso)==TRUE) %>%
  mutate(zona_pais=ifelse(grepl("Montevideo", inciso)==1,
                          "Montevideo", "Interior"))  %>%
  filter("2018-01-01" < fecha_compra, fecha_compra < "2018-12-31", monto_adj > 0) %>%
  group_by(floor_date(fecha_compra, "month"), zona_pais) %>% 
  summarise(total_comprado = sum(monto_adj_pesos, na.rm = TRUE)) %>%
  ggplot(aes(x=`floor_date(fecha_compra, "month")`, y=total_comprado, fill=zona_pais)) +
  geom_bar(stat="identity", position="dodge") +
  labs(x = NULL, y = "Monto total adjudicado por mes\n(equivalente en millones de pesos corrientes)\n") +
  scale_fill_discrete(name="Zona del país", palette=) +
  scale_y_continuous(labels = scales::dollar_format(prefix = "$U", big.mark = ".", decimal.mark = ",", scale = 1/1e6)) +
  ggthemes::theme_economist() +
  theme(axis.title = element_text(face = "bold"))

adj_julio_interior <- compras %>%
  filter(grepl("Intendencia", inciso)==TRUE) %>%
  mutate(zona_pais=ifelse(grepl("Montevideo", inciso)==1,
                          "Montevideo", "Interior"))  %>%
  filter("2018-07-01" < fecha_compra, fecha_compra < "2018-07-31") %>% 
  arrange(desc(monto_adj_pesos)) %>% select(objeto, monto_adj_pesos) %>% head(n=1) 

```

Se observa que durante la mayor parte del año, el monto adjudicado por la Intendencia de Montevideo es mayor que el del resto de todas las intendencias de todo el país.

Esto no es cierto en los meses febrero, marzo, y abril, en los cuales el gasto realizado por las intendencias del interior es ligeramente mayor al de la de Montevideo; y en Julio, mes en el que se da el mayor monto de adjudicación de todos, el cual es notablemente superior al resto.

Dicha adjudicación figura en la base como _`r adj_julio_interior[,1]`_ y tuvo un monto de $U`r prettyNum(adj_julio_interior[,2]/1e6, big.mark = ".", decimal.mark = ",", digits=0)` millones.





[^1]: [web-scrapping](https://es.wikipedia.org/wiki/Web_scraping)es una técnica utilizada mediante programas de software para extraer información de sitios web. 

[1]: https://github.com/ddapueto/workGroup_Stat/blob/master/xmlParsePython/Parse_compras_estatales.py "Github code"
[2]: https://github.com/ddapueto/workGroup_Stat/blob/master/compras_estatales.R "Github code"

