---
title: "Compras Estatales"
author: "Daniel Czarnievicz"
date: "Última actualización: `r format(Sys.time(), '%A %d %B, %Y, %I:%M %p')`"
output: 
  html_document:
    toc: true
    toc_depth: 2
    number_sections: true
    toc_float: 
      smooth_scroll: true
    theme: united
    highlight: tango
    fig_caption: true
    code_folding: hide
    includes:
      in_header: header.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
knitr::knit_hooks$set(inline = function(x) {prettyNum(x, big.mark = ".")})
library(knitr)
library(tidyverse)
library(lubridate)
library(formattable)
library(kableExtra)
```

```{r}
compras <- readr::read_rds("Csv/compras.rds")
adjudicaciones <- readr::read_rds("Csv/adjudicaciones.rds")
oferentes <- readr::read_rds("Csv/oferentes.rds")
```

# Análisis oferentes {.tabset .tabset-fade .tabset-pills}

```{r cant_provs_oferentes}
cant_provs_oferentes <- oferentes %>% 
  count(nro_doc_prov) %>% 
  dim() %>% 
  .[1]
```

```{r cant_compras_oferentes}
cant_compras_oferentes <- oferentes %>% 
  count(id_compra) %>% 
  dim() %>% 
  .[1]
```

La base cuenta con información sobre `r cant_provs_oferentes` proveedores, los cuales han partidicado de un total de `r cant_compras_oferentes` compras. El proveedor más frecuente es Nalfer SA, quien participó en el 4,10% de las compras.

```{r}
oferentes %>% 
  group_by(nro_doc_prov, nombre_comercial) %>% 
  summarise(n_compras = n_distinct(id_compra)) %>% 
  ungroup() %>%
  mutate(prop = percent(n_compras / sum(n_compras), digits = 2)) %>%
  arrange(desc(n_compras)) %>%
  select(nombre_comercial, nro_doc_prov, n_compras, prop) %>% 
  head(20) %>%
  kable(format = "html", format.args = list(big.mark = ".", decimal.mark = ","), escape = FALSE,
        caption = "Principales oferentes del Estado en 2018 y 2019",
        col.names = c("Proveedor", "ID", "Cantidad", "Proporción")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

```{r eval=FALSE}
# intento frustrado de determinar prooveeedores locales y extranjeros
# best guess: E y X son extranjeros, el resto locales
# missing data para más de la mitad de los proveedores
# tipos_doc_proveedor <- readr::read_rds("Csv/meta_tipos_doc_proveedor.rds")
# residencia <- readr::read_csv2("Csv/adjudicatariosNacionales2018.csv")
# left_join(oferentes, select(compras, id_compra, fecha_compra), by = "id_compra") %>% 
#   filter(fecha_compra >= "2018-01-01") %>% 
#   distinct(nro_doc_prov, tipo_doc_prov) %>% 
#   left_join(select(residencia, numero_doc_prov, dep_nombre), by = c("nro_doc_prov" = "numero_doc_prov"))
# table(unique(filter(oferentes, tipo_doc_prov %in% c("C", "G", "N", "R", "T"))$nro_doc_prov) %in% residencia$numero_doc_prov)
# oferentes %>% 
#   left_join(select(residencia, numero_doc_prov, dep_nombre), by = c("nro_doc_prov" = "numero_doc_prov")) %>% 
#   count(tipo_doc_prov, dep_nombre) %>% 
#   left_join(select(tipos_doc_proveedor, tipo, descripcion), by = c("tipo_doc_prov" = "tipo")) %>% 
#   select(descripcion, tipo_doc_prov, dep_nombre, n) %>% 
#   filter(is.na(dep_nombre))
#   
# arrange(desc(n)) %>% 
#   kable(format = "html", format.args = list(big.mark = ".", decimal.mark = ","),
#         ) %>% 
#   kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

# Análisis compras

```{r, fig.align='center', fig.cap="Evolución del monto total adjudicado por mes\n(en millones de pesos corrientes)"}
# falta convertir los montos que no son en pesos, a pesos
compras %>% 
  filter("2018-01-01" < fecha_compra, fecha_compra < "2019-01-01", monto_adj > 0) %>%
  group_by(floor_date(fecha_compra, "month")) %>% 
  summarise(total_comprado = sum(monto_adj)) %>% 
  ggplot() +
  geom_line(aes(`floor_date(fecha_compra, "month")`, total_comprado)) +
  labs(x = NULL, y = "Monto total adjudicado por mes\n(equivalente en millones de pesos corrientes)\n") +
  scale_y_continuous(labels = scales::dollar_format(prefix = "$U", big.mark = ".", scale = 1/1e6)) +
  ggthemes::theme_economist() +
  theme(axis.title = element_text(face = "bold"))
```

```{r, fig.align='center', fig.cap="Evolución de la cantidad de adjudicaciones mensuales"}
compras %>% 
  filter("2018-01-01" < fecha_compra, fecha_compra < "2019-01-01", monto_adj > 0) %>%
  group_by(floor_date(fecha_compra, "month")) %>% 
  tally() %>% 
  ggplot() +
  geom_line(aes(`floor_date(fecha_compra, "month")`, n)) +
  labs(x = NULL, y = "Cantidad de adjudicaciones mensuales\n") +
  scale_y_continuous(labels = scales::number_format(big.mark = ".")) +
  ggthemes::theme_economist() +
  theme(axis.title = element_text(face = "bold"))
```

<!--
http://www.sthda.com/english/articles/32-r-graphics-essentials/128-plot-time-series-data-using-ggplot/
-->

